<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8" />
  <title>BCF Topic Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Trimble Connect Workspace API -->
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#0069d9;
      --success:#28a745;
      --danger:#e74c3c;
      --gray:#6c757d;
      --border:#e5e7eb;
      --card:#ffffff;
      --bg:#f5f5f7;
      --text:#111827;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ====== HEADER (logo + overskrift) ====== */
    header{
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 14px;
      background:var(--card);
      border-bottom:1px solid var(--border);
    }

    .logoBox{
      width:92px;
      height:92px;
      border-radius:12px;
      background:#fff;
      border:1px solid #eee;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:0 1px 3px rgba(15,23,42,.08);
      flex:0 0 auto;
    }
    .logoBox img{
      width:84px;
      height:84px;
      object-fit:contain;
      display:block;
    }

    .titleBlock{ display:flex; flex-direction:column; gap:2px; }
    .title{ font-weight:800; font-size:18px; color:var(--primary); line-height:1.1; }
    .org{ font-weight:700; font-size:13px; opacity:.9; }
    .dev{ font-size:11px; opacity:.75; font-style:italic; }

    .headerRight{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    #status{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    button{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--primary);
      background:var(--primary);
      color:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    button.secondary{
      border:1px solid #777;
      background:#777;
    }
    button:disabled{ opacity:.6; cursor:default; }

    .loading-spinner{
      display:inline-block;
      width:12px;
      height:12px;
      border-radius:50%;
      border:2px solid #ccc;
      border-top-color:var(--primary);
      animation:spin .8s linear infinite;
      margin-right:6px;
      vertical-align:-2px;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    /* ====== MAIN ====== */
    main{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:12px 14px 18px 14px;
      gap:12px;
      overflow:auto;
    }

    #error{
      font-size:13px;
      color:#b00020;
      white-space:pre-wrap;
    }

    /* "Linje mellom grafer": vi gjør grid uten "gap" + border på hvert kort,
       slik at det oppleves som linjer mellom alle grafer */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(340px, 1fr));
      gap:0;
      align-items:stretch;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:var(--card);
    }

    .card{
      background:var(--card);
      padding:12px 12px 14px 12px;
      display:flex;
      flex-direction:column;
      min-height:240px;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }
    /* Fjern dobbeltlinjer på siste kolonne/rad håndteres av overflow+grid */
    .card:last-child{ border-right:0; }

    .card h2{
      margin:0 0 8px 0;
      font-size:14px;
      font-weight:800;
    }

    .divider{
      height:1px;
      background:var(--border);
      margin:8px 0 10px 0;
    }

    .summary-value{
      font-size:28px;
      font-weight:900;
      line-height:1.1;
      margin:6px 0 6px 0;
    }

    .small-text{
      font-size:12px;
      color:#6b7280;
      margin-top:8px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }

    .kpi{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .kpi .label{ font-size:12px; color:#6b7280; margin-bottom:2px; }
    .kpi .value{ font-size:18px; font-weight:900; }

    canvas{
      width:100% !important;
      height:240px !important;
    }

    code{
      background:#f3f4f6;
      padding:1px 5px;
      border-radius:6px;
      border:1px solid #e5e7eb;
      font-size:12px;
    }
  </style>
</head>

<body>
  <!-- ====== HEADER (likt mht overskrift + logo) ====== -->
  <header>
    <div class="logoBox">
      <!-- Legg logo-filen i samme mappe som HTML, eller bytt src -->
      <img src="norconsult-logo-black.png" alt="Norconsult logo"
           onerror="this.style.display='none'; this.parentElement.textContent='Norconsult'; this.parentElement.style.fontWeight='900';">
    </div>

    <div class="titleBlock">
      <div class="title">BCF Topic Stats</div>
      <div class="org">Norconsult Norge</div>
      <div class="dev">Developed by Edin Dzakmic, Norconsult, (AI-assisted development)</div>
    </div>

    <div class="headerRight">
      <div id="status"><span class="loading-spinner"></span>Kobler til Trimble Connect…</div>
      <button class="secondary" id="clearHistoryBtn" title="Sletter trenddata lagret lokalt i nettleseren">Tøm historikk</button>
      <button id="refreshBtn">Oppdater data</button>
    </div>
  </header>

  <main>
    <div id="error"></div>

    <div class="cards">
      <!-- ====== Oversikt ====== -->
      <div class="card">
        <h2>Oversikt</h2>
        <div class="small-text" id="projectInfo">–</div>
        <div class="divider"></div>

        <div class="small-text">Antall BCF Topics i prosjektet:</div>
        <div id="totalTopics" class="summary-value">–</div>

        <div class="kpi-grid">
          <div class="kpi">
            <div class="label">Åpne saker (nå)</div>
            <div class="value" id="openNow">–</div>
          </div>
          <div class="kpi">
            <div class="label">Lukkede saker (nå)</div>
            <div class="value" id="closedNow">–</div>
          </div>
          <div class="kpi">
            <div class="label">Median behandlingstid (dager)</div>
            <div class="value" id="medianCycle">–</div>
          </div>
          <div class="kpi">
            <div class="label">Snitt behandlingstid (dager)</div>
            <div class="value" id="avgCycle">–</div>
          </div>
        </div>

        <div class="small-text">
          Behandlingstid = <code>modified_date - creation_date</code> for topics som tolkes som “lukkede”.
        </div>
      </div>

      <!-- ====== Tidslinje: alle saker + status + avg cycle time ====== -->
      <div class="card">
        <h2>Tidslinje (alle topics + status)</h2>
        <div class="divider"></div>
        <canvas id="timelineAllChart"></canvas>
        <div class="small-text">
          Viser total (kumulativt) + linjer per status (snapshot-basert) + linje for snitt behandlingstid.
        </div>
      </div>

      <!-- ====== Trend pr Status ====== -->
      <div class="card">
        <h2>Trend: Topics per Status</h2>
        <div class="divider"></div>
        <canvas id="statusTrendChart"></canvas>
        <div class="small-text">Snapshot-basert utvikling over tid (antall per status per oppdatering).</div>
      </div>

      <!-- ====== Trend pr Type ====== -->
      <div class="card">
        <h2>Trend: Topics per Type</h2>
        <div class="divider"></div>
        <canvas id="typeTrendChart"></canvas>
        <div class="small-text">Snapshot-basert utvikling over tid (antall per type per oppdatering).</div>
      </div>

      <!-- ====== Trend pr Priority ====== -->
      <div class="card">
        <h2>Trend: Topics per Priority</h2>
        <div class="divider"></div>
        <canvas id="priorityTrendChart"></canvas>
        <div class="small-text">Snapshot-basert utvikling over tid (antall per priority per oppdatering).</div>
      </div>

      <!-- ====== Nå-situasjon (bar charts) ====== -->
      <div class="card">
        <h2>Nå: Topics per Type</h2>
        <div class="divider"></div>
        <canvas id="typeChart"></canvas>
        <div class="small-text">Basert på <code>topic_type</code> (eller <code>type</code>).</div>
      </div>

      <div class="card">
        <h2>Nå: Topics per Priority</h2>
        <div class="divider"></div>
        <canvas id="priorityChart"></canvas>
        <div class="small-text">Basert på <code>priority</code> (hvis brukt i prosjektet).</div>
      </div>

      <div class="card">
        <h2>Nå: Topics per Status</h2>
        <div class="divider"></div>
        <canvas id="statusChart"></canvas>
        <div class="small-text">Basert på <code>topic_status</code> (eller <code>status</code>).</div>
      </div>
    </div>
  </main>

  <script>
    let API = null;
    let accessToken = null;
    let currentProjectId = null;

    // "Nå"-charts
    let typeChart = null;
    let priorityChart = null;
    let statusChart = null;

    // Trend-charts
    let timelineAllChart = null;
    let statusTrendChart = null;
    let typeTrendChart = null;
    let priorityTrendChart = null;

    // Host for BCF API (endre hvis miljøet ditt krever annen base)
    const TOPICS_API_BASE = "https://open21.connect.trimble.com";

    // Lokal historikk (trend)
    const HISTORY_KEY_PREFIX = "bcf_topic_stats_history__";
    const historyKey = (projectId) => HISTORY_KEY_PREFIX + projectId;

    // Farger (for "nå"-bar charts)
    const STATUS_COLORS = {
      "New": "#3684D1",
      "Open": "#FCC603",
      "In Progress": "#FCC603",
      "Waiting": "#29B35B",
      "Done": "#36B7D1",
      "Closed": "#36B7D1"
    };

    const PRIORITY_COLORS = {
      "Low": "#72A544",
      "Normal": "#005F9E",
      "Medium": "#005F9E",
      "High": "#FFBE00",
      "Critical": "#C81922"
    };

    const TYPE_COLORS = {
      "Issue": "#FF0000",
      "Clash": "#F908E9",
      "Request": "#FFFF00"
    };

    const DEFAULT_BAR_COLOR = "#9CA3AF";

    // Tilpass disse om prosjektet bruker andre statuser
    const CLOSED_STATUSES = new Set(["Closed", "Done", "Resolved", "Approved"]);
    const OPEN_STATUSES = new Set(["New", "Open", "In Progress", "Waiting", "ReOpened", "Reopen"]);

    function setStatus(message, isLoading = false) {
      const el = document.getElementById("status");
      el.innerHTML = isLoading
        ? `<span class="loading-spinner"></span>${escapeHtml(message)}`
        : escapeHtml(message);
    }

    function setError(message) {
      document.getElementById("error").textContent = message || "";
    }

    function setBusy(isBusy) {
      document.getElementById("refreshBtn").disabled = isBusy;
      document.getElementById("clearHistoryBtn").disabled = isBusy;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function safeStr(v) {
      if (v === null || v === undefined) return "";
      return String(v).trim();
    }

    function parseDateMaybe(v) {
      const s = safeStr(v);
      if (!s) return null;
      const d = new Date(s);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function toISODate(d) {
      const year = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${m}-${day}`;
    }

    function median(values) {
      if (!values.length) return null;
      const sorted = [...values].sort((a,b)=>a-b);
      const mid = Math.floor(sorted.length / 2);
      return (sorted.length % 2 !== 0) ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    }

    function avg(values) {
      if (!values.length) return null;
      const sum = values.reduce((a,b)=>a+b, 0);
      return sum / values.length;
    }

    function countByKey(items, getter, emptyLabel = "Ikke satt") {
      const counts = {};
      for (const it of items) {
        const raw = getter(it);
        const key = (raw && String(raw).trim()) || emptyLabel;
        counts[key] = (counts[key] || 0) + 1;
      }
      return counts;
    }

    // --- Charts ---
    function buildBarChart(ctx, counts, colorMap) {
      const labels = Object.keys(counts);
      const data = labels.map(l => counts[l]);
      const colors = labels.map(label => (colorMap && colorMap[label]) ? colorMap[label] : DEFAULT_BAR_COLOR);

      return new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Antall Topics",
            data,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.y} topics` } }
          },
          scales: {
            x: { ticks: { font: { size: 11 }, autoSkip: false, maxRotation: 45, minRotation: 0 } },
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }

    function buildMultiLineTrendChart(ctx, labels, seriesMap, chartTitle) {
      // seriesMap: { seriesName: [values...] }
      const datasets = Object.keys(seriesMap).map(name => ({
        label: name,
        data: seriesMap[name],
        tension: 0.25
      }));

      return new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: false, text: chartTitle }
          },
          scales: {
            x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true } },
            y: { beginAtZero: true, ticks: { precision: 0 } }
          }
        }
      });
    }

    function buildTimelineAll(ctx, labels, totalSeries, statusSeriesMap, avgCycleSeries) {
      const datasets = [];

      // Total topics (kumulativt)
      datasets.push({ label: "Total topics", data: totalSeries, tension: 0.25 });

      // Status-linjer (antall per status ved hvert snapshot)
      for (const name of Object.keys(statusSeriesMap)) {
        datasets.push({ label: `Status: ${name}`, data: statusSeriesMap[name], tension: 0.25 });
      }

      // Avg cycle time (dager)
      datasets.push({
        label: "Snitt tid New→Closed (dager)",
        data: avgCycleSeries,
        tension: 0.25,
        yAxisID: "y2"
      });

      return new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: "Antall" } },
            y2: {
              beginAtZero: true,
              position: "right",
              grid: { drawOnChartArea: false },
              ticks: { precision: 0 },
              title: { display: true, text: "Dager" }
            },
            x: { ticks: { maxRotation: 45, minRotation: 0, autoSkip: true } }
          }
        }
      });
    }

    // --- API ---
    async function fetchTopics(projectId) {
      if (!accessToken) throw new Error("Mangler accessToken – kunne ikke hente Topics.");

      const url = `${TOPICS_API_BASE}/bcf/3.0/projects/${encodeURIComponent(projectId)}/topics`;

      const resp = await fetch(url, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Accept": "application/json"
        }
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => "");
        throw new Error(`Topics API-feil (${resp.status}): ${text || resp.statusText}`);
      }

      const json = await resp.json();
      return Array.isArray(json) ? json : [];
    }

    // ===== Trend / snapshot (lokalt) =====
    function loadHistory(projectId) {
      try {
        const raw = localStorage.getItem(historyKey(projectId));
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function saveHistory(projectId, historyArr) {
      localStorage.setItem(historyKey(projectId), JSON.stringify(historyArr));
    }

    function upsertSnapshot(projectId, snapshot) {
      const history = loadHistory(projectId);
      const idx = history.findIndex(x => x.date === snapshot.date);
      if (idx >= 0) history[idx] = snapshot;
      else history.push(snapshot);

      history.sort((a,b) => a.date.localeCompare(b.date));
      saveHistory(projectId, history);
      return history;
    }

    function clearHistory(projectId) {
      localStorage.removeItem(historyKey(projectId));
    }

    // --- KPI/counters ---
    function computeOpenClosedFromStatusCounts(statusCounts) {
      let open = 0, closed = 0;
      for (const [st, n] of Object.entries(statusCounts)) {
        if (CLOSED_STATUSES.has(st)) closed += n;
        else if (OPEN_STATUSES.has(st)) open += n;
        else open += n;
      }
      return { open, closed };
    }

    function computeCycleTimesDays(topics) {
      // "Snitt tid fra opprettet til lukket" (bruker modified_date som proxy for lukket-tidspunkt)
      const days = [];
      for (const t of topics) {
        const st = safeStr(t.topic_status || t.status);
        if (!CLOSED_STATUSES.has(st)) continue;

        const cd = parseDateMaybe(t.creation_date);
        const md = parseDateMaybe(t.modified_date);
        if (!cd || !md) continue;

        const diffMs = md.getTime() - cd.getTime();
        if (diffMs < 0) continue;

        days.push(diffMs / (1000 * 60 * 60 * 24));
      }
      return days;
    }

    function normalizeCountsObject(obj) {
      // sørg for rene tall
      const out = {};
      for (const [k,v] of Object.entries(obj || {})) out[k] = Number(v) || 0;
      return out;
    }

    function unionKeysAcrossHistory(history, keyName) {
      // keyName: 'statusCounts' | 'typeCounts' | 'priorityCounts'
      const keys = new Set();
      for (const h of history) {
        const m = h[keyName] || {};
        Object.keys(m).forEach(k => keys.add(k));
      }
      return [...keys].sort((a,b) => a.localeCompare(b));
    }

    function buildSeriesMap(history, keyName, seriesKeys) {
      // returns { key: [values per history index] }
      const map = {};
      for (const k of seriesKeys) map[k] = [];
      for (const h of history) {
        const m = normalizeCountsObject(h[keyName] || {});
        for (const k of seriesKeys) map[k].push(m[k] || 0);
      }
      return map;
    }

    function updateNowCharts(typeCounts, priorityCounts, statusCounts) {
      if (typeChart) typeChart.destroy();
      if (priorityChart) priorityChart.destroy();
      if (statusChart) statusChart.destroy();

      typeChart = buildBarChart(document.getElementById("typeChart").getContext("2d"), typeCounts, TYPE_COLORS);
      priorityChart = buildBarChart(document.getElementById("priorityChart").getContext("2d"), priorityCounts, PRIORITY_COLORS);
      statusChart = buildBarChart(document.getElementById("statusChart").getContext("2d"), statusCounts, STATUS_COLORS);
    }

    function updateTrendCharts(history) {
      const labels = history.map(h => h.date);

      // Trend: per status/type/priority
      const statusKeys = unionKeysAcrossHistory(history, "statusCounts");
      const typeKeys = unionKeysAcrossHistory(history, "typeCounts");
      const priorityKeys = unionKeysAcrossHistory(history, "priorityCounts");

      const statusSeries = buildSeriesMap(history, "statusCounts", statusKeys);
      const typeSeries = buildSeriesMap(history, "typeCounts", typeKeys);
      const prioritySeries = buildSeriesMap(history, "priorityCounts", priorityKeys);

      // Timeline "alt": total + status-linjer + avg cycle time
      const totalSeries = history.map(h => Number(h.totalCount) || 0);
      const avgCycleSeries = history.map(h => {
        const v = Number(h.avgCycleDays);
        return Number.isFinite(v) ? Math.round(v) : null;
      });

      if (timelineAllChart) timelineAllChart.destroy();
      timelineAllChart = buildTimelineAll(
        document.getElementById("timelineAllChart").getContext("2d"),
        labels,
        totalSeries,
        statusSeries,
        avgCycleSeries
      );

      if (statusTrendChart) statusTrendChart.destroy();
      statusTrendChart = buildMultiLineTrendChart(
        document.getElementById("statusTrendChart").getContext("2d"),
        labels,
        statusSeries,
        "Trend per Status"
      );

      if (typeTrendChart) typeTrendChart.destroy();
      typeTrendChart = buildMultiLineTrendChart(
        document.getElementById("typeTrendChart").getContext("2d"),
        labels,
        typeSeries,
        "Trend per Type"
      );

      if (priorityTrendChart) priorityTrendChart.destroy();
      priorityTrendChart = buildMultiLineTrendChart(
        document.getElementById("priorityTrendChart").getContext("2d"),
        labels,
        prioritySeries,
        "Trend per Priority"
      );
    }

    function updateUIAndAllCharts(topics) {
      // Counts (nå)
      const typeCounts = countByKey(topics, t => t.topic_type || t.type, "Ikke satt");
      const priorityCounts = countByKey(topics, t => t.priority, "Ikke satt");
      const statusCounts = countByKey(topics, t => t.topic_status || t.status, "Ikke satt");

      document.getElementById("totalTopics").textContent = String(topics.length);

      const oc = computeOpenClosedFromStatusCounts(statusCounts);
      document.getElementById("openNow").textContent = String(oc.open);
      document.getElementById("closedNow").textContent = String(oc.closed);

      const cycleDays = computeCycleTimesDays(topics);
      const med = median(cycleDays);
      const av = avg(cycleDays);

      document.getElementById("medianCycle").textContent = (med === null) ? "–" : String(Math.round(med));
      document.getElementById("avgCycle").textContent = (av === null) ? "–" : String(Math.round(av));

      // Oppdater "nå"-charts
      updateNowCharts(typeCounts, priorityCounts, statusCounts);

      // Snapshot for trend
      const today = new Date();
      const todayKey = toISODate(today);

      const snapshot = {
        date: todayKey,
        totalCount: topics.length,
        openCount: oc.open,
        closedCount: oc.closed,
        statusCounts,
        typeCounts,
        priorityCounts,
        avgCycleDays: (av === null) ? null : av,
        medianCycleDays: (med === null) ? null : med
      };

      const history = upsertSnapshot(currentProjectId, snapshot);

      // Oppdater trend-charts
      updateTrendCharts(history);
    }

    async function refreshData() {
      if (!currentProjectId) {
        setError("Mangler projectId – er extensionen lastet i et Trimble Connect-prosjekt?");
        return;
      }

      setBusy(true);
      setError("");
      setStatus("Henter BCF Topics …", true);

      try {
        const topics = await fetchTopics(currentProjectId);
        updateUIAndAllCharts(topics);
        setStatus(`Sist oppdatert: ${new Date().toLocaleString()}`);
      } catch (err) {
        console.error(err);
        setError("Feil ved henting av Topics: " + (err.message || err));
        setStatus("Klar, men med feil ved siste oppdatering.");
      } finally {
        setBusy(false);
      }
    }

    function handleAccessTokenPayload(payload) {
      if (!payload) return;

      if (typeof payload === "string") {
        if (payload === "pending" || payload === "denied") return;
        accessToken = payload;
        refreshData();
        return;
      }

      if (typeof payload === "object") {
        if (payload.status === "denied") {
          setError("Tilgang til accessToken ble avslått i Trimble Connect-innstillinger.");
          setStatus("Kan ikke hente BCF Topics uten accessToken.");
        } else if (payload.accessToken) {
          accessToken = payload.accessToken;
          refreshData();
        }
      }
    }

    async function init() {
      setError("");
      setStatus("Kobler til Trimble Connect …", true);

      try {
        API = await TrimbleConnectWorkspace.connect(window.parent, (event, args) => {
          if (event === "extension.accessToken") {
            handleAccessTokenPayload(args.data);
          }
        });

        const projectInfo = await API.project.getCurrentProject();
        currentProjectId = projectInfo.id;

        document.getElementById("projectInfo").textContent =
          `Prosjekt: ${projectInfo.name} (ID: ${projectInfo.id})`;

        // last inn historikk og tegn trend-charts selv før første fetch
        const history = loadHistory(currentProjectId);
        if (history.length) updateTrendCharts(history);

        setStatus("Ber om tilgang til accessToken …", true);
        const permissionResult = await API.extension.requestPermission("accesstoken");
        handleAccessTokenPayload(permissionResult);

        if (permissionResult === "pending") {
          setStatus("Venter på at bruker godkjenner tilgang …", true);
        } else if (permissionResult === "denied") {
          setError("Tilgang til accessToken ble avslått i Trimble Connect-innstillinger.");
          setStatus("Kan ikke hente BCF Topics uten accessToken.");
        } else if (typeof permissionResult === "string") {
          accessToken = permissionResult;
          await refreshData();
        } else if (permissionResult && permissionResult.accessToken) {
          accessToken = permissionResult.accessToken;
          await refreshData();
        } else {
          setStatus("Venter på accessToken …", true);
        }
      } catch (err) {
        console.error(err);
        setError("Klarte ikke å koble til Trimble Connect Workspace API: " + (err.message || err));
        setStatus("Feil ved initialisering.");
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", refreshData);

    document.getElementById("clearHistoryBtn").addEventListener("click", () => {
      if (!currentProjectId) return;
      clearHistory(currentProjectId);

      // destroy trend charts
      if (timelineAllChart) timelineAllChart.destroy();
      if (statusTrendChart) statusTrendChart.destroy();
      if (typeTrendChart) typeTrendChart.destroy();
      if (priorityTrendChart) priorityTrendChart.destroy();

      timelineAllChart = statusTrendChart = typeTrendChart = priorityTrendChart = null;

      setStatus("Historikk tømt (lokalt). Oppdater data for å bygge trend på nytt.");
    });

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
